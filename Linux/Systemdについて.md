# Systemd について

## init/upstart ではダメだったこと

起動順序

1. /etc/rc.d/rc/sysinit の実行
   ルートファイルシステムのマウント  
   サービス起動の下準備を行う
2. /etc/init.d/以下のシェルスクリプトを実行
   順次サービスを起動する

rc.sysinit を含めて、個々のサービスの起動処理はすべて shellscript で実装されている。  
スクリプトの書き方次第で様々な処理が実施可能

shellscript だからの短所

- お作法に従わない shellscript があるとシステムの動作が予測不能になる。
- shellscript を逐次実行していくので起動動作がおっそい。
- システム起動後にオンデマンドでサービスを起動・停止する仕組みがない。
- サービスごとに cgroups でリソース配分を調整するような仕組みも無い。

Systemd では、こういった shellscript に依存した起動処理を完全に排除することで問題を解決している。

## Systemd の管理方法

systemd では、「Unit」と呼ばれる単位で処理を管理する。  
rc.ssysinit やサービス起動スクリプトが実施していた処理内容はすべて Unit として定義される。

Unit は大きく下記の役割に分担される。

- target
- mount
- service
- device
- etc...

起動手順は下記の通り。

1. PID=1 の最初のプロセスとして systemd が起動する。
2. 「default.target」という Unit を頂点にして依存関係ツリーを構築する。
3. 依存関係のツリーを構築した後、依存する Unit を起動する。  
   この時、それぞれの Unit は依存関係の情報とは別に、起動順序について設定が与えられる。  
   起動順序の指定がない場合、依存関係のある Unit についても並列に起動処理が行われる。

Systemd の特徴

- shellscript を利用しないので実行速度が速い
- Unit の起動処理は可能な限り並列化が可能  
  依存関係と順序関係を別定義できるので、依存はしているが起動順序は関係ない部分を並列化できる。  
  upstart では依存関係＝順序関係だったため、ここが最も違うとも言える。
- Unit の起動をオンデマンド化できる  
  「特定のデバイスが接続された」「D-Bus 経由でサービスが要求された」などを設定可能

## Systemd の依存関係

Unit の定義ファイルの場所
|ディレクトリ|概要|
|:----------:|:-----|
|/usr/lib/systemd|Fedora でのシステムデフォルト設定。RPM パッケージが提供するデフォルト設定を配置する|
|/etc/systemd/system|ユーザー設定。同名ファイルがシステムデフォルトにある場合、こちらが優先される|
|/usr/share/systemd|arch 非依存の設定ファイル。お手本みたいなもん|

## 依存関係

とりあえず今はここまで
