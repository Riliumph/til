# え、HTTPSの転送なのにファイルも暗号化するんですか？？？

## TL;DR

- 基本的には二重での暗号は不要
- ただし、転送後も暗号化したまま使うなら、転送前から暗号化するのは良い
- ルールXを無邪気に追加して不整合のあるセキュリティルールを作ってはいけない

## はじめに

社内のセキュリティルールやスタンダードを決めるときに、HTTPSなのにVPN必須になってたりファイル暗号も必須になってたりするケースがある。  
今回は、それは実際に必要なことなのか？ セキュリティ的に有効なのか？ という点で考察する。

## 背景

二重三重に暗号化しても性能ペナルティが無いなら「なんとなく安全そうだから」でOKにしてしまいがちだが、一考の余地がある。  
「ルールXを追加することで既存のルールAと不整合が出る」ってことは割とよくある。

- 具体例：
  - SCPのファイル転送は（SCPのセキュリティに不備があった時の）安全性のためにファイル暗号をすべし

しかし、それによってその横で動いている同等のセキュリティ強度の「VPNの中を通している大量の平文」や「HTTPSの生ファイル転送」が本来は全部NGになってしまう。突き詰めれば「ユーザがHTTPS経由でWebサイトを通じて個人情報をやりとりする」自体がNGである。  
**インターネットが信頼出来ないから経路暗号を使い経路暗号も信用できないからファイル暗号を重ねて使うというルール**を作ると、一律NGにしないと同じ要件で違う運用がされてるダブスタになるのだ。

実際は「既存はそのまま」という謎の運用によりルールXと矛盾したダブスタ運用がされていく。  
別にVPNであってもファイル暗号を必須にしたり、「SCPのファイル転送」ではなく実は「大量の個人情報」とかセキュリティを強化したい明確な基準があり、その基準に則って運用するのは全く問題無いが、そこら辺が曖昧だったり矛盾のまま突き進んだりすると困りもの。

ルールというのは一般的に「例外はあっても良い」が「不整合や矛盾」があると運用が面倒になってしまう。基準が曖昧になるので。曖昧な基準は不必要な無限のコストや守らないことの常態化（オオカミ状態で大切なケースでも無視される）を招くため可能な限り避けねばならない。

というわけで、前置きがとても長くなりましたが今回はそもそも経路暗号であるHTTPS/SCPとファイル暗号を組み合わせる必要はあるのかを考察していきます。

## なぜ暗号化するのか？

これは実は結構重要な確認です。  
ここでは、データを見せたく無かったり改ざん防止など当たり前の理由を確認するのではない。  
それ以前に重要な「誰から守るか？」を確認する。

例えば、

- インターネットなど信頼できない経路での通信の盗聴から守りたい
- クラウド業者などデータを預けた先で自分たちのデータが彼らに閲覧させない
- 社員やステークホルダーであっても特定メンバー以外には見せたくない

それぞれの目的に応じて適切な方法は異なってくる。

## 暗号化のタイミング

暗号化はそのタイミングによって以下のように分けることもできる。

- 経路の暗号
  - 通信を暗号化して盗聴に対する対策を行うための暗号化
- ストレージの暗号
  - ファイルサーバやストレージといったインフラ自体を暗号化
  - 盗難やオペレータからの不正アクセスを防止する
- コンテンツ/ファイルの暗号
  - DBの中のデータそのものやファイル自体の暗号化
  - 透過的な暗号ではなく利用者から見ても暗号化されているため明示的な復号作業が必要になる

今回は主に経路暗号とコンテンツ/ファイルの暗号に関し話しをする。

## VPNやHTTPSによる経路の暗号

経路の暗号について。

- VPN(IPSec, SSL-VPN)
- HTTPS
- SSH

パフォーマンスや利便性、そもそもレイヤーなど色んな違いはあるが、ことセキュリティ強度でいえば最新技術を適用してる限りは大して変わらない。  
どの技術もRSA等利用した公開鍵暗号(非対称鍵暗号)やAESのような共通鍵(対称鍵暗号)を組合わせた「ハイブリッド暗号 ※1」である。  
暗号アルゴリズムが同じであれば基本的には「HTTPSよりVPNの方がセキュアとかではない」というのが重要。

> 以下のサイトにIPSecとTLSの違いが載っています。  
> [【図解】IPsecとSSL/TLSの違い ～セキュリティ強度や用途,メリット/デメリットの比較～](https://milestone-of-se.nesuke.com/nw-basic/tls/compare-with-ipsec-and-tls/)

一方で、HTTPSを含めたTLSは通常はIPSecと違いサーバのみを認証するためクライアント側が何者であるかが分からない。

不特定多数からアクセスされるような公開Webサーバでは良いが、特定の組織やシステムからのみアクセスを許可したい社内システムや企業間連携のときにはこれだと困る。

そこでTLSでもmTLS (mutual-TLS)と呼ばれるクライアント認証の仕組みを使うことで双方向認証が可能。  
また、アプリケーションそのものやIDaaS等なにかしらの認証基盤などで適切な認証が行われていればクライアントの認証はそれで良い、という考え方もあり。どこで認証するかの違いだけ。

> ※1 通常はお互いの共通鍵と自身の秘密鍵から共通の秘密情報を生成する鍵交換という手法が用いられる。  
> [2つの公開鍵暗号(公開鍵暗号の基礎知識)](https://qiita.com/angel_p_57/items/897bf94160be8d637585#%E9%8D%B5%E4%BA%A4%E6%8F%9B)

## ファイル/コンテンツの暗号

ちょっと前に話題になったみんな大好きパスワード付きZipもファイルの暗号。  
もしくは、DBの場合はカラム単位で暗号化して格納するようなケース。

通常はファイルを暗号化するならば今なら共通鍵方式のAES256あたりが採用される事が多いハズ。技術的にはRSAなどの公開鍵を使ったファイルの暗号化も可能だが、公開鍵では特性上大きなデータを暗号化できない。そのためファイルに使うことはあまり無い。なので、ファイル暗号に対して公開鍵のような非対称の性質を利用したい場合はハイブリッド暗号を用いる必要がある。

ファイル暗号は例えば経路が暗号化されてないネットワークを使わざる得ないときとか、イマイチ信用しきれないクラウドストレージを使う時とか、ファイルやデータ自体にはアクセス出来ても特定の人間にのみパスワードや認証基盤を使って公開したいときや、暗号化したまま運用したい時に利用する。

ZoomのE2E暗号云々が一時話題になりましたが、P2Pではないシステムで真のE2Eを実現する場合もHTTPS/TLSだけでは困難なのでコンテンツの暗号が必要になるハズ。これもクラウド業者側を信用しなくて良くするための仕組みである。

## HTTPS/SCPによるファイル転送でもファイル暗号はするべきだろうか？

本題。  
経路暗号がされてる状態でもファイル暗号/コンテンツ暗号は必要か？

私の結論としては「基本的には不要。ただしあった方が良い場合もある」である。

### TLSやSCPの暗号が解かれたらどうするの？

まず、暗号が解かれ単純にTLSやSSHが突破される場合を想定する。これに関しては可能性は0では無いかもしれないが、正直考えても仕方がない。  
HTTPSの暗号を復号する技術ができれば多分ファイル暗号だって解かれるハズだ。どうせAESとか同じようなアルゴリズムを選んでいるだろう。

先日もRSA暗号を破壊するとの論文が発表されるも「ほぼ誤報」とみられるというニュースが流れTwitterでは当初から誤報扱いで大喜利祭りだった。RSA暗号が仮に解かれてもインターネットが壊れるレベルの被害ではないという説もあるが、甚大な影響を出すしAES256とかならお祭りである。コンピュータ性能は年々上昇しているし、量子コンピュータが完成するとそれらも解かれるという説もあるので心配になる気持ちは分からなくはない。

しかしながら、適切な暗号化アルゴリズムに常に追従していけば、たとえ量子コンピュータが登場してもゼロデイ以外は問題ない。  
「でもゼロデイは防げないんでしょ？」と言われるとその通りだが、ゼロデイを防ぐレベルのシステムとは政府・軍事システムである。  
アルゴリズム自体が解かれるリスクを考えるならば対策はオフラインや完全な専用ネットワークでの運用しかない。二重暗号では不十分なのだ。  
そこまでのコストをかけるべきリスクがあるなら、そこまでやれ。

あと、古くて弱い暗号使ってると普通に突破されるのでやめろ。

### TLSやSCPの脆弱性が発見されることもあるよね？

アルゴリズムそのものではなく、実装や仕様の脆弱性の話。これは想定が必要だ。
基本的には適切にパッチを当てておけば問題無いハズで、運用の課題だが、未来永劫問題が絶対でないとはとても言えない。

この点に関してはリスク見合いでの判断になる。大量の個人情報の流出のリスクがあるケースなどは考慮しても良いのかもしれない。ただ、この手の脆弱性が原因で通信を覗かれて大量流出てのは（あるかもしれないが）私は聞いたこと無いので闇雲に行わず、秘密鍵のやり取りとかそういうかなり限定的な部分で十分なのではないだろうか。

### 中間者攻撃で盗み見られる場合もあるよね？

カフェのWiFiなどを利用した中間者攻撃にはHTTPSやVPNの利用が良い例だ。  
通信情報を除き見られてもクライアント・サーバ間でE2Eに暗号化がされていれば問題無い。DNSが偽装されてもHTTPSのホスト認証で弾かれる。

中間者攻撃という呼び方はしない気がするが、DC内や専用線であっても通信の暗号化が求められる理由もEndではない間の事業者やオペレータが見れてしまう可能性があるから。このように経路の暗号は中間者攻撃にとても有効。

~~しかし、昨今はより巧妙な手口も出てきているようです。VPNサーバやHTTPSな相手サイト自体がクラックされてる場合はそもそも別ですが、巧妙なマルウェアはHTTPSであっても中間者攻撃を成立させる場合があるようです。
<https://jp.globalsign.com/blog/articles/maninthemiddleattack.html>~~
※ これは参照した記事の内容がやはり相当怪しそう。普通に証明書エラーになる気はするし、信頼できるルート証明書発行機関ならドメイン認証してるから他人のドメインを登録自体できないはず。 GlobalSign...

要はProxyとして動作しProxy自体を正規の繋ぎ先としてクライアントに返す。ネゴシエーションの時点から本人のフリをするので一見気づくことが出来ない。普通にやると下記の試された記事ように証明書の警告が出るはずだが、上記のGlobal Signの記事はEV証明書の組織の部分を使えと言ってるので正規の証明書を使えばそこら辺の警告が出ないという話かもしれない。個人的にはEV証明書が現実的に役立つとも思えないが、それはそれ。

悪意があるルータやWiFiが本気を出せばDNSやIP含めてほぼすべての情報は偽装可能な気はする。それとオレオレじゃない正規の証明書を組み合わせた場合に中間者攻撃はどこまで成立するのかは、ちょっと自分の中でも消化しきれてない。非対称鍵や共通の秘密を持ってないのでどこかで失敗しそうな気はする。ゼロトラストの文脈に反してる気もするので問題あるなら話題になりそうだが。

この問題自体は成立するならばある程度警戒する必要があるが、あくまで信頼できないNW機器を利用してる場合なので原則サーバ間通信の時には考慮不要だ。同じDC内や別のDCあるいは別の会社のDCへのファイル転送とかではこのリスクを気にする必要はあまり無いハズなので、するとしてもWFH向けの運用のときに考慮となる。

## クラウド業者は信用出来ないよね？

これは経路の懸念ではなく通信先のシステムが信用しきれない場合。

荒唐無稽かもしれない、監査を受けるような業界のシステムだと結構大事な観点。特に、法律が異なる国外の業者を利用する時は注意。（個人情報守ってます！ といっても「個人情報の定義はなに？」とか）

これはそもそも通信の暗号に関わる部分ではないため、HTTPSで暗号化済みのファイルを転送するという事に意味がある。ファイル暗号を積極的に活用したいケースの一つ。ただし、転送直前に暗号化して転送直後に復号するような運用だと全く意味がないので、転送後も暗号化したままにしておく運用が基本になる。

とはいえクラウドだからと過剰に心配する必要も無いかと気がする。  
特に、3大クラウドはHIPPAとかPCI-DSSとかメジャーな第三者認証を取得していて、「信用に足る運用がされている」と言えるハズだ。注意点としてはAWSなどPCI-DSSやHIPPAに認定されたインフラを使うからと言って、その上で動くファイル共有サービスなどのSaaSが必ずしもPCI-DSSやHIPPAに準拠してるとは言えないことだ。ちゃんとSaaS側も確認して自分たちの取れるリスクなのかを確認するべき。

## 自分のDCや社員だからって信用できないよね？

クラウドのケースとほぼ同じですが自分たちのインフラや社員だからって信用できない。  
これも転送中の経路ではなく転送後の運用が信用できないと言ってるので暗号化する意味がある。

ここでもクラウドの時と同様に転送のタイミングだけ二重暗号化するなら意味がない。あくまで、転送の前後のオペレーションで暗号化したまま取り扱いたいから暗号化して運用するということ。

余談だがファイル転送ではなくAPIとかだと結構これが大事になる。というのも、エラー処理などでログに通信内容を吐く場合があるからだ。当然これはトレースやデバッグの観点で重要な行為なのだが、個人情報等を含む場合はセキュリティ的にはマズイので暗号化ないしは匿名化/仮名化をしておきましょう。

> 某通信会社Kでは、リリースビルドのアプリでのログトレースを諦めて、特定のログ内容を「*」埋めしていた

## 結局いるの？　いらないの？

基本的には要らない。  
ただし、リスクや運用目的に応じて特定のデータは通信経路に関わらずファイル暗号をかける。

正直「転送」という極めて短いタイムラインでピンポイントにゼロデイ攻撃を受けるリスクを想定して過剰だったり複雑になる運用は避けるべきという考え方だ。専用線やDCなどかつては信頼出来るとさえれたNWの上でも暗号化するのが現在のスタンダードだが、あれは内部の中間運用者(及びそれらを利用したマルウェア)による盗聴を懸念しているので、経路の暗号化をしていれば十分に果たせるハズ。経路暗号だけで内部の人でもエンドではない中間では盗聴出来ない。仮に適用するにしても「大量の個人情報」とか「Root証明書」とか極めて高いリスクのデータと認定されたものだけで十分。

そうではなく、転送前後の運用に注目してファイル暗号を考えるべき。基本的には暗号化したまま保管したり取り扱うデータに関しては HTTPSの転送なのにファイルも暗号化する意味がある。例えばACLをある程度緩めざる得ないIT管理者に対して、うっかり大量の個人情報を見てしまうのを防ぐとか。そのような観点でセキュリティルールを作るのが良い。暗号化したままの運用を求められるものは通常はリスクが高いデータなので結果的に上記の極めて高いリスクのデータのファイル転送をHTTPS等のゼロデイから守ることにも繋がる。
