# SurfhsarkのVPNの仕組み

## VPNの基本

### 仮想NICの生成

VPNは、原則として仮想NIC（以下、VPN-NIC）を生成する。  
このVPN-NICを通して通信すると、パケットはVPNサーバーへ送られて暗号化される。

Surfsharkの場合、`Wintun`という仮想NICが多いらしい @ ChatGPT

仮想NICには[TUN/TAP](https://ja.wikipedia.org/wiki/TUN/TAP)が存在する。

- Terminal Access Pointはイーサネットデバイスをシミュレートして[L2](https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%AF%E5%B1%A4)を操作する。
- TUNnelは[L3](https://ja.wikipedia.org/wiki/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%B1%A4)をシミュレートし、IPパケットを操作する

具体的には、、TAPはブリッジに使われ、TUNはルーティングに使われる。

NICが有効（Up）になっている。

```console
Name                      InterfaceDescription                    ifIndex Status       MacAddress             LinkSpeed
----                      --------------------                    ------- ------       ----------             ---------
イーサネット              Realtek PCIe GBE Family Controller           22 Up           xx-xx-xx-xx-xx-xx         1 Gbps
vEthernet (Default Swi... Hyper-V Virtual Ethernet Adapter              8 Up           xx-xx-xx-xx-xx-xx        10 Gbps
vEthernet (WSL (Hyper-... Hyper-V Virtual Ethernet Adapter #3          34 Up           xx-xx-xx-xx-xx-xx        10 Gbps
vEthernet (WSLCore)       Hyper-V Virtual Ethernet Adapter #2          26 Up           xx-xx-xx-xx-xx-xx        10 Gbps
OpenVPN Data Channel O... OpenVPN Data Channel Offload                 11 Up                                     1 Gbps
Bluetooth ネットワーク... Bluetooth Device (Personal Area Netw...      10 Disconnected xx-xx-xx-xx-xx-xx         3 Mbps
```

### ルーティングテーブルの変更

次に、ルーティングテーブルを書き換える。

`0.0.0.0/0`のデフォルトゲートウェイを仮想NICにすることで、全トラフィックをVPNに経由させることができる。

```console
PS> route print
===========================================================================
インターフェイス一覧
 11...........................OpenVPN Data Channel Offload
 22...88 d7 f6 7c 10 bb ......Realtek PCIe GBE Family Controller
 10...e8 48 b8 c8 20 00 ......Bluetooth Device (Personal Area Network)
  1...........................Software Loopback Interface 1
  8...00 15 5d 97 b3 81 ......Hyper-V Virtual Ethernet Adapter
 26...00 15 5d b9 d2 31 ......Hyper-V Virtual Ethernet Adapter #2
 34...00 15 5d 80 00 69 ......Hyper-V Virtual Ethernet Adapter #3
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
          0.0.0.0          0.0.0.0         192.168.0.1         192.168.0.111        25
          0.0.0.0        128.0.0.0          10.11.11.1            10.11.11.4         3
       10.11.11.0    255.255.255.0            リンク上             10.11.11.4       259
       10.11.11.4  255.255.255.255            リンク上             10.11.11.4       259
     10.11.11.255  255.255.255.255            リンク上             10.11.11.4       259
    93.118.41.100  255.255.255.255         192.168.0.1         192.168.0.111        25
    104.18.30.114  255.255.255.255         192.168.0.1         192.168.0.111        25
    104.18.31.114  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.16.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.32.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.48.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.64.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.80.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.21.96.1  255.255.255.255         192.168.0.1         192.168.0.111        25
     104.21.112.1  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.26.4.72  255.255.255.255         192.168.0.1         192.168.0.111        25
      104.26.5.72  255.255.255.255         192.168.0.1         192.168.0.111        25
   124.146.171.25  255.255.255.255         192.168.0.1         192.168.0.111        25
        127.0.0.0        255.0.0.0            リンク上              127.0.0.1       331
        127.0.0.1  255.255.255.255            リンク上              127.0.0.1       331
  127.255.255.255  255.255.255.255            リンク上              127.0.0.1       331
        128.0.0.0        128.0.0.0          10.11.11.1            10.11.11.4         3
   142.250.76.142  255.255.255.255         192.168.0.1         192.168.0.111        25
  142.250.206.206  255.255.255.255         192.168.0.1         192.168.0.111        25
  142.250.206.238  255.255.255.255         192.168.0.1         192.168.0.111        25
  142.250.207.110  255.255.255.255         192.168.0.1         192.168.0.111        25
   143.204.79.153  255.255.255.255         192.168.0.1         192.168.0.111        25
   153.120.132.19  255.255.255.255         192.168.0.1         192.168.0.111        25
     172.18.192.0    255.255.240.0            リンク上           172.18.192.1      5256
     172.18.192.1  255.255.255.255            リンク上           172.18.192.1      5256
   172.18.207.255  255.255.255.255            リンク上           172.18.192.1      5256
     172.24.128.0    255.255.240.0            リンク上           172.24.128.1      5256
     172.24.128.1  255.255.255.255            リンク上           172.24.128.1      5256
   172.24.143.255  255.255.255.255            リンク上           172.24.128.1      5256
     172.31.192.0    255.255.240.0            リンク上           172.31.192.1      5256
     172.31.192.1  255.255.255.255            リンク上           172.31.192.1      5256
   172.31.207.255  255.255.255.255            リンク上           172.31.192.1      5256
    172.67.73.148  255.255.255.255         192.168.0.1         192.168.0.111        25
   172.217.25.174  255.255.255.255         192.168.0.1         192.168.0.111        25
  172.217.161.206  255.255.255.255         192.168.0.1         192.168.0.111        25
     184.29.6.170  255.255.255.255         192.168.0.1         192.168.0.111        25
      192.168.0.0    255.255.255.0            リンク上          192.168.0.111       281
    192.168.0.111  255.255.255.255            リンク上          192.168.0.111       281
    192.168.0.255  255.255.255.255            リンク上          192.168.0.111       281
        224.0.0.0        240.0.0.0            リンク上              127.0.0.1       331
        224.0.0.0        240.0.0.0            リンク上             10.11.11.4       259
        224.0.0.0        240.0.0.0            リンク上          192.168.0.111       281
        224.0.0.0        240.0.0.0            リンク上           172.31.192.1      5256
        224.0.0.0        240.0.0.0            リンク上           172.18.192.1      5256
        224.0.0.0        240.0.0.0            リンク上           172.24.128.1      5256
  255.255.255.255  255.255.255.255            リンク上              127.0.0.1       331
  255.255.255.255  255.255.255.255            リンク上             10.11.11.4       259
  255.255.255.255  255.255.255.255            リンク上          192.168.0.111       281
  255.255.255.255  255.255.255.255            リンク上           172.31.192.1      5256
  255.255.255.255  255.255.255.255            リンク上           172.18.192.1      5256
  255.255.255.255  255.255.255.255            リンク上           172.24.128.1      5256
===========================================================================
固定ルート:
  なし

IPv6 ルート テーブル
===========================================================================
（略）
===========================================================================
固定ルート:
  なし
```

## 実際に通信してみる

GoogleのDNSに対してテスト接続してみる

```console
# VPNが無効の時
PS> Test-NetConnection -ComputerName 8.8.8.8
ComputerName           : 8.8.8.8
RemoteAddress          : 8.8.8.8
InterfaceAlias         : イーサネット
SourceAddress          : 192.168.0.111
PingSucceeded          : True
PingReplyDetails (RTT) : 2 ms

# VPNが有効の時
PS> Test-NetConnection -ComputerName 8.8.8.8
ComputerName           : 8.8.8.8
RemoteAddress          : 8.8.8.8
InterfaceAlias         : OpenVPN Data Channel Offload for Surfshark
SourceAddress          : 10.11.11.4
PingSucceeded          : True
PingReplyDetails (RTT) : 12 ms
```

VPNが使われていることが分かる。
