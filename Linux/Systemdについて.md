# Systemd について

参考

- [いまさらだけど systemd に入門した](http://yukiyan.hatenablog.jp/entry/2015/10/18/190639)

## init/upstart ではダメだったこと

起動順序

1. /etc/rc.d/rc/sysinit の実行
   ルートファイルシステムのマウント  
   サービス起動の下準備を行う
2. /etc/init.d/以下のシェルスクリプトを実行
   順次サービスを起動する

rc.sysinit を含めて、個々のサービスの起動処理はすべて shellscript で実装されている。  
スクリプトの書き方次第で様々な処理が実施可能

shellscript だからの短所

- お作法に従わない shellscript があるとシステムの動作が予測不能になる。
- shellscript を逐次実行していくので起動動作がおっそい。
- システム起動後にオンデマンドでサービスを起動・停止する仕組みがない。
- サービスごとに cgroups でリソース配分を調整するような仕組みも無い。

Systemd では、こういった shellscript に依存した起動処理を完全に排除することで問題を解決している。

## Systemd の管理方法

systemd では、「Unit」と呼ばれる単位で処理を管理する。  
rc.ssysinit やサービス起動スクリプトが実施していた処理内容はすべて Unit として定義される。

Unit は大きく下記の役割に分担される。

| unit 名/拡張子 |    何をするか    | 設定タイミング           | 説明                                                           |
| :------------: | :--------------: | :----------------------- | :------------------------------------------------------------- |
|     mount      | マウントポイント | `/etc/fstab`から自動作成 | 有効化するとマウントされる                                     |
|      swap      |    Swap 領域     | `/etc/fstab`から自動作成 | Swap 領域が有効になる                                          |
|     target     |    何もしない    | 設定ファイルで明示定義   | 依存関係・順序関係を定義する際に、複数の Unit をグループ化する |
|    service     |     サービス     | 設定ファイルで明示定義   | 有効化すると対応するデーモンが起動する                         |
|     device     |     デバイス     | udev によって自動作成    | udev がデバイスを認識すると有効化される                        |
|     socket     |     ソケット     |                          | systemd が特定のソケットを Listen する                         |
|     etc...     |                  |                          |                                                                |

起動手順は下記の通り。

1. PID=1 の最初のプロセスとして systemd が起動する。
2. 「default.target」という Unit を頂点にして依存関係ツリーを構築する。
3. 依存関係のツリーを構築した後、依存する Unit を起動する。  
   この時、それぞれの Unit は依存関係の情報とは別に、起動順序について設定が与えられる。  
   起動順序の指定がない場合、依存関係のある Unit についても並列に起動処理が行われる。

Systemd の特徴

- shellscript を利用しないので実行速度が速い
- Unit の起動処理は可能な限り並列化が可能  
  依存関係と順序関係を別定義できるので、依存はしているが起動順序は関係ない部分を並列化できる。  
  upstart では依存関係＝順序関係だったため、ここが最も違うとも言える。
- Unit の起動をオンデマンド化できる  
  「特定のデバイスが接続された」「D-Bus 経由でサービスが要求された」などを設定可能

## Systemd の配置

Unit の定義ファイルの場所

|      ディレクトリ       | 概要                                                                                |
| :---------------------: | :---------------------------------------------------------------------------------- |
| /usr/lib/systemd/system | Fedora でのシステムデフォルト設定。RPM パッケージが提供するデフォルト設定を配置する |
|   /etc/systemd/system   | ユーザー設定。同名ファイルがシステムデフォルトにある場合、こちらが優先される        |
|   /usr/share/systemd    | arch 非依存の設定ファイル。お手本みたいなもん                                       |

### 依存関係

「A という Unit を有効化するなら、B という Unit も有効化するべき」関係

### 順序関係

「A という Unit を有効化する前に、B という Unit を有効化するべき」関係

## 書き方

Unit の設定ファイルは以下のセクションに分かれる。

| セクション名 | 説明文                                                        |
| :----------: | :------------------------------------------------------------ |
|    [Unit]    | Unit の依存・順序関係など Unit のタイプに依存しない設定を記載 |
|  [Install]   | `systemctl enable/disable`コマンドに関連する設定を記載        |
|  [Service]   | service タイプに固有の設定項目を記載                          |

### Unit セクションのオプション

| オプション名  | 説明文                                    |
| :-----------: | :---------------------------------------- |
|  Description  | Unit の説明文                             |
| Documentation | ドキュメントの URI                        |
| Require/Wants | この Unit と同時に有効化が必要な前提 Unit |
|     After     | この Unit より前に起動するべき Unit       |
|    Before     | この Unit より後に起動するべき Unit       |

> - Require: 前提 Unit の起動失敗により起動をキャンセル。
> - Wants: 前提 Unit の起動失敗を無視する。

オプションを複数項目記載する際は、スペース区切りもしくは同じオプションを複数記載する。

> After=A B C  
> もしくは  
> After=A  
> After=B  
> After=C

### Install セクションのオプション

| オプション名 | 説明文                                                                    |
| :----------: | :------------------------------------------------------------------------ |
|   WantedBy   | enable 時に。この Unit の wants ディレクトリに symbolic link を作成する   |
|  RequiredBy  | enable 時に、この Unit の require ディレクトリに symbolic link を作成する |
|     Also     | enable/disable 時に状態が連動する Unit                                    |

### Service セクションのオプション

いくつか体系に分けて解説する。

|  オプション名   | 説明文                                        |
| :-------------: | :-------------------------------------------- |
|    ExecStart    | サービスの起動コマンド                        |
|   ExecReload    | サービスのリロードコマンド                    |
|  ExecStartPre   | サービスの起動前の追加コマンド                |
|  ExecStartPost  | サービスの起動後の追加コマンド                |
|  ExecStopPost   | サービスの停止後に実行するコマンド            |
| EnvironmentFile | 環境変数を読み込むファイル                    |
|    KillMode     | ExecStop で停止せずに残ったプロセスの処理方法 |

ExecStart の実行結果で起動の成功・失敗が判定される。 ExecStartPre/Post の結果は判定基準に入らない。

> ExecStartPre/Post はサービス起動判定に関連させたくないコマンドを記載するべき

ExecStopPost は終了の正常・異常に関わらず実行される。

---

| オプション名 | 説明文                                         |
| :----------: | :--------------------------------------------- |
|     Type     | サービスプロセスの起動完了判定方法             |
|   PIDFile    | Fork 型サービスのメインプロセスの PID ファイル |
|   BusName    | D-Bus 型サービスの bus 接続名                  |
|   Restart    | サービスプロセス停止時の再起動条件             |

- Type オプションの種類
  |値|説明文|
  |:--:|:--|
  |simple|指定コマンドが fore 実行を継続する場合、コマンド実行した直後に起動完了とする|
  |forking|子プロセスを back で起動して、最初のコマンドは終了する場合、最初のコマンド終了時を起動完了とする|
  |oneshot|一度だけコマンドを実行するサービスの場合、コマンド終了時に起動完了判定し、サービスを終了したと認識|
  |notify|systemd ライブラリ関数`sd_nitify()`を使用する場合、プロセスプログラム内でコールする|

---

|      オプション名       | 説明文                                         |
| :---------------------: | :--------------------------------------------- |
|       User/Group        | プロセスを起動するユーザー/グループ            |
|       PrivateTmp        | このサービス専用の`/tmp`と`/var/tmp`を用意する |
|   ReadOnlyDirectories   | 指定ディレクトリ以下を ReadOnly とする         |
| InaceessibleDirectories | 指定のディレクトリ以下をアクセス不可とする     |
|      RootDirectory      | 指定のディレクトリに chroot する               |
