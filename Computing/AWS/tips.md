# TIPS

## ECRの削除権限は剥奪するべき

ECRの削除権限を持っている場合、ECRのイメージを削除できる。  
これ自体は、現在動いているFargateに対しては特に問題はない。  
ただ、Fargateのオートスケール設定によりスケールアウトする場合、新しいタスクはECRのイメージを改めて拾いに行くためイメージを引っ張ることができず、スケールアウトに失敗する。

よって、本番環境への削除権限は剥奪しておくことが望ましい。

## S3Syncは結構遅い

FargateのログをEFSに吐き出し、S3へ転送する。  
転送にはFluentdとかではなく、AWS　APIのS3Syncを用いる。  
このS3Syncがなかなかに重い。248Bの7000ファイルを送るのに30分ほどかかっている。  
本来は、CloudWatch+Firehoseを使ったりするのだろうが、こういう構成になった場合は注意せよ

## CloudFormationは使い所によっては美味しくない

CFnは構成管理の側面を持つ。  
そのため、構成は手ではなくCFnを使いたい。  
しかし、CFnで作った上に手で構成を「追加・削除」した場合はCFn構成管理と齟齬が発生してしまい、CFnの更新を当てることができない。  
ALBの設定だから、ALBのCFnにまとめて記載とかそうするとALBの中の何かの構成を変更することができな行くなる。  
特に、以下のことが発生した。

1. APPチームに加えて運用チームの構成をまとめてVPCというCFnを作成した
2. 運用チームの構成が変わってしまい、APPチームのCFnを掛け直さざるをえなくなった、

こんなことが起きないように、頭脳によってCFnを分けて管理すること

> 頭脳とは、サービスの決定権を持つ人たちのこと。  
> 今回は、サービスの決定権として、開発陣と運用陣があるためそれによって分けるべきという話。

## IPアドレスが変わる

AWSはスケーリング時などにIPアドレスが変化する時がある。  
例えば、ElastiCacheのRedisをKeep-Aliveありで接続していたとする。  
この場合、IPアドレスが変化してもアプリ側は検知できないため、古いIPアドレスにアクセスしてしまう。  
これは、AWS側としてはどうしようもないとしている。  

対処方法は無い。  
ただし、一度繋がらなくなったらエラーは返えるが、繋がらなくなったことが判明したらAWSは新しいルーティング先を知らせる。  
これは１秒以内とされている。  
よって、コンシューマー側にリトライの責任を求めるべきである。

「一度、アクセスに失敗したからと言って、すぐバックエンド側に頼るな。リトライぐらいしろ」ということである。  
こんなことを担保するような契約はやめよう。
