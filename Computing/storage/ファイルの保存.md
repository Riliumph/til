# ファイルを保存する方法

急に対象のストレージに書き込むと、そこでストレージが満杯になってエラーになることがある。  
その時に、例外でコントロールを親に返して結果を書き出せずに終わった。

なーんてことになるのは避けたい。  
ファイルの保存が一瞬で終わるならいいけど、エンコードしながらですごい時間がかかるなら嫌になるだろう。

もっというとNASなんてのは本当に不安定で、通信エラーやタイムアウトで保存できないこともしばしば起きる。

## 一時ファイルに吐いて移動

1. ローカルのtmpディレクトリに書き込む
1. 目的のディレクトリにmoveする

これで対応することが多い。

同じストレージならファイル移動はメタデータの変更で済む。  
つまり、現実的にはアトミック操作となる。（もちろん、厳密には違うが）

別ストレージになるとそうはいかない。  
実態をコピー、元ファイルの削除が走る。  
そのため、途中で失敗すると不完全なファイルが残ることになる。


## じゃあ、2回保存したらいい？

ローカルと目的のディレクトリの２つにファイルを生成して、どっちもできたらローカルを消す。

Q. これじゃダメなのか？  
A. ダメではないが、無駄は多い。

ちょっとしたファイルなら問題ないだろう。  
ただし、画像ファイルになるとファイルを２回エンコードすることになる。  
画像でもそうだが、動画なんて以ての外だ。  
移動したほうが効率的である。
