# Elastic Container Service

![概念図](./img/product-page-diagram_ECS.png)

ECSの概念として、ベースのサーバーにEC2/Fargateの選択があり、その上でDockerによるコンテナVMを起動できるサービスである。

## EC2+ECS

ECSの基盤にEC2を用いる方法。  
EC2なので、自由にソフトウェアを入れることができる。  
そのため、sshなどでサーバーの中に入ることができる。  
これにより、Dockerが共有ボリュームを張って内容を見ることができる。

また、EFSやEBSなどのストレージを使う場合は、AWSデフォルトの設定を使うこともできれば、自分で`mount`することもできる。

## Fargate+ECS

FargateはDockerを起動するためだけのサービス。  
これを基盤に添えることで、あらゆる設定をAWSの裁量で決めてくれる。

ただし、Fargateはあくまで起動サーバーでしかなく、自由なソフトウェアを入れることができないためSSH接続ができない。  
サーバー内に接続できないため、EC2+ECSのようにDocker内で動くソフトのログを取得できない。

そのため、マウント設定が用意されてる。

### BindMount

Fargateの上でタスクと呼ばれるDockerVMが動くので、Fargateとタスクが共有ファイルを張る仕組み。  
単純なDockerによる共有ボリュームである。

こうやったとしてもFargateにSSH接続することができないので何の意味があるのかというとコンテナ間でファイルを共有することができる。

例：Fargate+ECS / Fluentd  
Fargateの上で、アプリコンテナとログ収集コンテナの２台を立ち上げる。  
この両コンテナが、Fargateの同じパスに共有ボリュームを張ることことで同じファイルを共有することができる。  
こうすることでアプリコンテナが書き出したログをFluentdが別のストレージに転送するということが実現できる。  
これにより本来接続できないFargate内のログを収集することができる。  

ただし、問題が無いわけではない。  
たとえば、Fluentdが障害により動作しなくなった場合、どんなことをしてもアプリのログを収集することができなくなる。

### EFS

BindMountでFargate内に書き込むことでログが拾えない可能性が捨てきれないという話はした。  
EC2+ECSだったら自由にできるんだが、ここでFargateにも救いの手となる設定が加えられた。

EFSという無尽蔵ストレージをマウントすることができる。  
これはFargateがEFSをNFSマウントしてNFS通信を行うことでログをFargateの外に出すことができる。  

しかし、問題が無いわけではないのだ！
EFSの接続はデフォルト設定のマウントコマンドが使われる。

```bash
$ mount -v
xxx.xxx.xxx.xxx:/ on /mnt/efs_mount_point type nfs4 (rw, realtime, vers=4.1, rsize=1048576, wsize=1048576, hard, noresvport, proto=tcp, timeo=600, retrans=2, sec=sys, clientaddr=yy.yy.yy.yy local_lock=none, addr=xxx.xxx.xxx.xxx)
)
```

> hard/softマウント
> soft オプションを指定してマウントされた NFS ファイルシステムは、サーバが応答しなくなるとI/Oエラーを返す。  
> hard オプションが指定してマウントされた NFS ファイルシステムは、サーバが応答するまで再試行をけい↑うする。  
> デフォルトは hard です。ほとんどのファイルシステムには hard を使用します。  
> soft マウントされたファイルシステムからの値を検査しないアプリが多いので、アプリでエラーが発生してファイルが破壊されるおそれがあるためです。検査するアプリケーションの場合でも、ルーティングの問題などによってアプリケーションが正しい判断をできずに、ファイルが破壊されることがあります。原則として、soft は使用しないでください。hard オプションを指定した場合にファイルシステムが使えなくなると、そのファイルシステムを使うアプリケーションはファイルシステムが復旧するまでハングする可能性があります。
