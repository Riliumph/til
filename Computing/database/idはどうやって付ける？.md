# IDカラムはどうやって作る？

Primary Keyとしてのidを数値とするとuuidとするか？

## Postgresを使うなら

- UUIDv7
- シャーディング想定なし
- モノリスアーキテクチャ

であれば高速。ただし、v7でも推測しやすくはある。

結局、内部向けのuuidと外部向けidとIDを２つ作ってセキュリティ高めるとかする必要があるかもしれない。

## サービスの規模感は？

たとえば、

- 5000万とかユーザーがいるなら？
- AWSみたいにN億API/dayの発行数だったら？

みたいなスケールが大きいサービスなら、キャッシュヒット率も見ないといけない。  
当然、uuidはランダム性が高く、B-Treeインデックスでは局所性が失われる。  
インデックスのアチコチに書かれるためpage splitも発生し、インデックスが肥大化し、そしてキャッシュがヒットしなくなる。

この規模のサービスではキツイんじゃないだろうか？

## UUIDはキャッシュヒット率を落とすのか？

serial型の場合、連番なのでB-Treeの末尾に挿入される。  
だが、それと違ってUUIDv7ではランダムな値が発生する。このランダム挿入によりB-Treeは予想以上に肥大化していく。  
木が常に分割されて、ページが増え（page split）てしまう。


また、インデックスのページが局所化しない問題もある。  
serialなら隣接するキーが近くのページに収まることからキャッシュ効率は高い。  
UUIDはランダム故にアクセスするページが散らばりキャッシュ効率は悪い。

加えて、インデックス量が基本的に小さい。  
serialの場合、4～8byteの使用量だが、  
UUIDの場合、16byteものメモリ諒である。

同じメモリでもUUIDだと載せられるデータは半分以下だ。
