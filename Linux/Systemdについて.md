# Systemdについて

## init/upstartではダメだったこと

起動順序
1. /etc/rc.d/rc/sysinitの実行
  ルートファイルシステムのマウント  
  サービス起動の下準備を行う  
2. /etc/init.d/以下のシェルスクリプトを実行
  順次サービスを起動する  

rc.sysinitを含めて、個々のサービスの起動処理はすべてshellscriptで実装されている。  
スクリプトの書き方次第で様々な処理が実施可能

shellscriptだからの短所
- お作法に従わないshellscriptがあるとシステムの動作が予測不能になる。
- shellscriptを逐次実行していくので起動動作がおっそい。
- システム起動後にオンデマンドでサービスを起動・停止する仕組みがない。
- サービスごとにcgroupsでリソース配分を調整するような仕組みも無い。

Systemdでは、こういったshellscriptに依存した起動処理を完全に排除することで問題を解決している。  

## Systemdの管理方法
systemdでは、「Unit」と呼ばれる単位で処理を管理する。  
rc.ssysinitやサービス起動スクリプトが実施していた処理内容はすべてUnitとして定義される。  

Unitは大きく下記の役割に分担される。 
- target
- mount
- service
- device
- etc...

起動手順は下記の通り。 
1. PID=1の最初のプロセスとしてsystemdが起動する。
2. 「default.target」というUnitを頂点にして依存関係ツリーを構築する。  
3. 依存関係のツリーを構築した後、依存するUnitを起動する。  
   この時、それぞれのUnitは依存関係の情報とは別に、起動順序について設定が与えられる。  
   起動順序の指定がない場合、依存関係のあるUnitについても並列に起動処理が行われる。  

Systemdの特徴
- shellscriptを利用しないので実行速度が速い  
- Unitの起動処理は可能な限り並列化が可能  
  依存関係と順序関係を別定義できるので、依存はしているが起動順序は関係ない部分を並列化できる。  
  upstartでは依存関係＝順序関係だったため、ここが最も違うとも言える。  
- Unitの起動をオンデマンド化できる  
  「特定のデバイスが接続された」「D-Bus経由でサービスが要求された」などを設定可能

## Systemdの依存関係
Unitの定義ファイルの場所
|ディレクトリ|概要|
|:----------:|:-----|
|/usr/lib/systemd|Fedoraでのシステムデフォルト設定。RPMパッケージが提供するデフォルト設定を配置する|
|/etc/systemd/system|ユーザー設定。同名ファイルがシステムデフォルトにある場合、こちらが優先される|
|/usr/share/systemd|arch非依存の設定ファイル。お手本みたいなもん|


## 依存関係
とりあえず今はここまで


