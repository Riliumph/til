# サーバー監視

サーバーはスケールイン・アウトを起こすことがあるとする。

## コスト観

お金は大事。どれだけ金食い虫なのかを判断しましょう。

|想定タスク数|0.5vCPU|1vCPU|2vCPU|4vCPU|
|:--:|:--:|:--:|:--:|:--:|
|2|500rps|700rps|1400rps|2800rps|
|4|1000rps|1400rps|2800rps|5600rps|
|...|||||

ただし、AWSのFargateを用いる場合は、AZの数が影響してくるので注意。  
たとえば、3AZ構成なので2タスクや4タスクの場合、AZに偏りが発生する。

||0.5vCPU|1vCPU|2vCPU|4vCPU|
|:--:|:--:|:--:|:--:|:--:|
|〜1000rps|14k|25k|24k|49k|
|〜3000rps|41k|64k|73k|98k|

など。

この表を見る限りはミニマムスケーリングをする方がいいということになる。  
つまり、高いスケールは余剰資源のお金が発生するためもったいない。  
そのため、貧弱スペックの並列インスタンスが無駄なく処理できる傾向にある。

## 自動スケーリング・ポリシーについて

AWS ECSのスケーリングは以下の種類がある。

### ターゲット追跡スケーリング

AWSの推奨ポリシー

特徴

- スケールアウトの判定は限りなく高速で行われる。
- スケールインの判定はより緩やかに行われる。

メリット・デメリット

- ＋：メトリクスの費になるように自動でスケールする
- ー：メトリクスデータを切り上げ・切り捨てを行うため、正確な閾値を設けることができない

### ステップ・スケーリング

ターゲット追跡スケーリングポリシーが使用できないときに用いられるポリシー

特徴

- 閾値を超えると、設定したタスク数にスケールイン・アウトする

デメリット

- ー：設計が複雑

### スケジュール・スケーリング

日付と時刻に基づいてスケーリングされるポリシー。

休日のみ出入りが多い場合などに用いられる。  
定期的にイベントが行われるような時に有効。

## 判定メトリクス

動かしているサービスによって変わるので、ちゃんとメトリクスに合わせた判定条件にすること。

- CPU
- メモリ
- リクエスト数
  - ALBとNLBなど入り口が複数ある場合は閾値設定が難しい
  - バイナリデータとテキストデータが同じ単位で計上されるため、実際のリソース状況と異なる場合がある。
- ストレージ使用率
- アプリ内遅延
  - アプリから遅延状況を通信する必要がある。
  - 異常監視と予兆監視で使える使えないが別れる。
    - 遅延が発生したからスケーリングする？
    - 遅延が発生しそうだからスケーリングする？
- プロセス・スレッド数
  - システムから使用率を引き揚げてくる必要あり。
  - 負荷との相関関係を調べる必要あり
    - Apacheならリクエスト毎にプロセスを生成する。
    - nginxならリクエスト毎にスレッドを生成する。
- ソケット数

## 監視する内容

- 慢性的なリソース不足  
  １分間常にCPUが90%に張り付いてるなど、サーバーのスケールアップ時期を判断するために設備担当に伝達する監視  
